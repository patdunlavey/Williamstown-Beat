<?php
// $Id: feeds.test,v 1.9 2010/02/10 23:49:35 alexb Exp $

/**
 * @file
 * Feeds tests.
 */

// Require FeedsWebTestCase class definition.
require_once(dirname(__FILE__) .'/feeds.test.inc');

/**
 * Test aggregating a feed as node items.
 */
class FeedsInheritTest extends FeedsWebTestCase {

  /**
   * Describe this test.
   */
  public function getInfo() {
    return array(
      'name' => t('Inheritance'),
      'description' => t('Tests functioning of feed inheritance settings, and of attribute (organic groups, author, taxonomy and language) inheritance from the feed node to the feed items generated by the feed. <strong>Requires Organic Groups module</strong>'),
      'group' => t('Feeds'),
    );
  }

  /**
   * Set up test.
   */
  public function setUp() {
    parent::setUp('feeds', 'feeds_ui', 'ctools', 'og', 'taxonomy');
    $this->drupalLogin(
      $this->drupalCreateUser(
        array(
          'administer feeds', 'administer nodes',
        )
      )
    );
  }

  /**
   * Test node creation, refreshing/deleting feeds and feed items.
   */
  public function test() {

    // Create a feed.
    $this->createFeedConfiguration('Syndication', 'syndication');
    $this->addMappings('syndication',
      array(
        array(
          'source' => 'title',
          'target' => 'title',
          'unique' => FALSE,
        ),
        array(
          'source' => 'description',
          'target' => 'body',
          'unique' => FALSE,
        ),
        array(
          'source' => 'timestamp',
          'target' => 'created',
          'unique' => FALSE,
        ),
        array(
          'source' => 'url',
          'target' => 'url',
          'unique' => TRUE,
        ),
        array(
          'source' => 'guid',
          'target' => 'guid',
          'unique' => TRUE,
        ),
      )
    );

        // Turn off inheritance
        $edit = array(
          'inherit' => array(
            'taxonomy' => FALSE,
            'og' => FALSE,
            'author' => FALSE,
            'language' => FALSE,
            )
        );
        
        // TODO: need to give parent feed node a taxonomy term...
        // TODO: need to create some taonomy terms / vocab
        
        $this->drupalPost('admin/build/feeds/edit/syndication/settings/FeedsNodeProcessor', $edit, 'Save');
//        $this->assertText('Do not allow feed nodes to inherit taxonomy terms.');
    
        $nids = $this->createFeedNodes();
        $this->assertText('Created 10 Story nodes.');
        
        /**
        * TODO:
        * 1. Check term(s) not been inherited
        * 2. Turn inheritance on
        * 3. Create feed node / etc.
        * 4. Check terms have been inherited
        */
    
  }
}
